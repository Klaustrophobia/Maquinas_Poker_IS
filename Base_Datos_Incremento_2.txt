-- Tipos ENUM
CREATE TYPE estado_maquina AS ENUM ('Fuera de servicio', 'Mantenimiento', 'Funcionando');
CREATE TYPE estado_orden AS ENUM ('Asignada', 'Proceso', 'Completada');
CREATE TYPE tipo_rol AS ENUM ('Administrador', 'Tecnico', 'Cliente');

-- Tabla de roles
CREATE TABLE roles (
  id bigint primary key generated always as identity,
  nombre tipo_rol not null unique,
  descripcion text,
  permisos jsonb,
  fecha_creacion timestamp with time zone default now()
);

-- Tabla de usuarios
CREATE TABLE usuarios (
  id bigint primary key generated always as identity,
  nombre_usuario text not null unique,
  contraseña text not null,
  rol tipo_rol not null,
  correo text not null unique,
  fecha_creacion timestamp with time zone default now(),
  identificador_unico text UNIQUE,
  activo boolean DEFAULT true,
  codigo_login text
);

-- Tabla de máquinas
CREATE TABLE maquinas (
  id bigint primary key generated always as identity,
  nombre text not null,
  tipo text not null,
  estado estado_maquina not null,
  ubicacion text not null,
  fecha_compra date,
  fecha_garantia date
);

-- Tabla de órdenes de reparación
CREATE TABLE ordenes_reparacion (
  id bigint primary key generated always as identity,
  maquina_id bigint references maquinas (id),
  cliente_id bigint references usuarios (id),
  tecnico_id bigint references usuarios (id),
  fecha_orden timestamp with time zone default now(),
  estado estado_orden not null,
  descripcion text,
  fecha_finalizacion timestamp with time zone
);

-- Tabla de contabilidad
CREATE TABLE contabilidad (
  id bigint primary key generated always as identity,
  fecha_transaccion timestamp with time zone default now(),
  monto numeric not null,
  tipo text not null,
  descripcion text,
  orden_reparacion_id bigint references ordenes_reparacion (id)
);

-- Tabla de proveedores
CREATE TABLE proveedores (
  id bigint primary key generated always as identity,
  nombre text not null,
  informacion_contacto text,
  direccion text,
  fecha_creacion timestamp with time zone default now()
);

-- Tabla de repuestos
CREATE TABLE repuestos (
  id bigint primary key generated always as identity,
  nombre text not null,
  proveedor_id bigint references proveedores (id),
  cantidad int not null,
  ubicacion text,
  estado text not null
);

-- Tabla de recibos
CREATE TABLE recibos (
  id bigint primary key generated always as identity,
  cliente_id bigint references usuarios (id),
  maquina_id bigint references maquinas (id),
  monto numeric not null,
  fecha_recibo timestamp with time zone default now()
);

-- Tabla de vales de pago
CREATE TABLE vales_pago (
  id bigint primary key generated always as identity,
  tecnico_id bigint references usuarios (id),
  monto numeric not null,
  fecha_vale timestamp with time zone default now()
);

-- Tabla intermedia para repuestos en órdenes de reparación
CREATE TABLE orden_reparacion_repuestos (
  id bigint primary key generated always as identity,
  orden_reparacion_id bigint references ordenes_reparacion (id),
  repuesto_id bigint references repuestos (id),
  cantidad int not null
);

-- Tabla de relación máquinas-cliente
CREATE TABLE maquinas_cliente (
  id bigint primary key generated always as identity,
  cliente_id bigint references usuarios (id),
  maquina_id bigint references maquinas (id),
  estado text not null,
  fecha_asignacion timestamp with time zone default now()
);

-- Insertar los roles básicos
INSERT INTO roles (nombre, descripcion) VALUES 
('Administrador', 'Acceso completo al sistema'),
('Tecnico', 'Puede gestionar reparaciones y mantenimiento'),
('Cliente', 'Puede ver sus máquinas y reportar problemas');

-- Crear índices para mejorar el rendimiento
CREATE INDEX idx_usuarios_rol ON usuarios(rol);
CREATE INDEX idx_usuarios_activo ON usuarios(activo);
CREATE INDEX idx_maquinas_estado ON usuarios(activo);
CREATE INDEX idx_ordenes_estado ON ordenes_reparacion(estado);
CREATE INDEX idx_ordenes_tecnico ON ordenes_reparacion(tecnico_id);
CREATE INDEX idx_ordenes_cliente ON ordenes_reparacion(cliente_id);
CREATE INDEX idx_contabilidad_fecha ON contabilidad(fecha_transaccion);
CREATE INDEX idx_recibos_fecha ON recibos(fecha_recibo);
CREATE INDEX idx_maquinas_cliente_cliente ON maquinas_cliente(cliente_id);
CREATE INDEX idx_maquinas_cliente_maquina ON maquinas_cliente(maquina_id);

-- Restricciones
ALTER TABLE maquinas_cliente
ADD CONSTRAINT unica_maquina_cliente UNIQUE (maquina_id);


-- Comentarios
COMMENT ON TABLE roles IS 'Tabla de roles del sistema con los tipos permitidos: Administrador, Tecnico, Cliente';
COMMENT ON COLUMN usuarios.rol IS 'Rol del usuario, solo permite: Administrador, Tecnico, Cliente';
COMMENT ON TABLE maquinas_cliente IS 'Relación entre clientes y las máquinas que tienen asignadas';
COMMENT ON TABLE orden_reparacion_repuestos IS 'Tabla intermedia para gestionar repuestos utilizados en órdenes de reparación';